#!/bin/bash
# c-basic-offset: 4; tab-width: 4; indent-tabs-mode: t
# vi: set shiftwidth=4 tabstop=4 noexpandtab:
# :indentSize=4:tabSize=4:noTabs=false:


# # i3lock on commputer sleep
#   Source: https://bbs.archlinux.org/viewtopic.php?pid=1170536#p1170536 by 65kid
#   Also: https://wiki.debian.org/ScreenLockingOnSleep
#

set -o nounset
set -o errexit
set -o pipefail

# always log
# shellcheck disable=SC2034
[ -z "${SYSTEMDSERVICE:-}" ] && [ "${DEBUG:-0}" -eq 0 ] &&
	FORCE_DEBUG_LOGGING="TRUE"

# shellcheck disable=SC1090
source "$HOME/bin/common.bash"

I3LOCK_ANNOTATETEXT="${LOCK_ANNOTATETEXT:-}"
I3LOCK_ICONS="${LOCK_ICONS:-$HOME/Pictures/icons/i3lock}"
I3LOCK_ICON="${LOCK_ICON:-$I3LOCK_ICONS/token.png}"
LOCK_SCREEN_IMAGE="${LOCK_SCREEN_IMAGE:-$HOME/.lockscreen.png}"
LOCKSCREEN="${1:-${LOCK_DEFAULT_LOCKSCREEN}}"
LOCKSLEEP=5

# SYSTEMDSERVICE is set to yes in the systemd service unit file
SYSTEMDSERVICE=${SYSTEMDSERVICE:-no}
MYUID="$(id -u "${USER}")"
PIDPATH=/var/run/user/${MYUID:-1000}/i3lock
PIDFILE=${PIDPATH}/pid
install -g serge -o serge -m 700 -d "${PIDPATH}"


##############################
## subroutines              ##
##############################


function systemdservice() {
	if [ "${SYSTEMDSERVICE}" = yes ]
	then
		return 0
	else
		return 1
	fi
}

function prepare() {
	if ! systemdservice
	then # these checks don't work when ran via systemd (needs dbus)
		notify "Check music players and sound volume."
		PLAYERCTLSTATUS="$(playerctl status ||:)"
		i3-volume is-muted && MUTED=yes || MUTED=no || :
	else
		PLAYERCTLSTATUS="unknown"
		MUTED="unknown"
	fi

	notify "Pick the right lockscreen image.(${SECONDS}s)"
	if [ ! "$LOCKSCREEN" = "keep" ] && [ ! "$LOCKSCREEN" = "blurred" ]
	then
		notify "Choosing a picture background."
		setbg lock "$LOCKSCREEN"
		notify "Converting single picture to multi-display"
		xrandr-background "${LOCK_SCREEN_IMAGE}" "${LOCK_SCREEN_IMAGE}"
		annotate_lockscreen
	elif [ "$LOCKSCREEN" = "blurred" ]
	then
		make_blurred
		annotate_lockscreen
	else
		notify "Keeping the current lockscreen."
		return
	fi

}

function make_blurred() {
	# take a screenshot and blur it for the lock screen
	notify "Take a screenshot and blur it."
	BLUR="-blur 0x5"

	# take screenshot
	time2 maim --format=png --hidecursor --quality 7 --quiet "${LOCK_SCREENSHOT_IMAGE}"

	# blur screenshot
	time2 convert "${LOCK_SCREENSHOT_IMAGE}" ${BLUR} "${LOCK_SCREEN_IMAGE}"
}

function annotate_lockscreen() {
	notify "Annotate lockscreen with lock symbol and optional text."

	TEXT="${I3LOCK_ANNOTATETEXT}"
	ICON="${I3LOCK_ICON}"

	# for some reason "convert -list font" returns 1
	FONT="$( (convert -list font ||:) | awk "{ a[NR] = \$2 } /family: $(fc-match sans -f "%{family}\n")/ { print a[NR-1]; exit }")"

	# calculate position for lock symbol and text
	LOCK=()
	while read -r LINE
	do
		if [[ "$LINE" =~ ([0-9]+)x([0-9]+)\+([0-9]+)\+([0-9]+) ]]; then
			W=${BASH_REMATCH[1]}
			H=${BASH_REMATCH[2]}
			Xoff=${BASH_REMATCH[3]}
			Yoff=${BASH_REMATCH[4]}
			MIDXi=$((W / 2 + Xoff - 60  / 2))
			MIDYi=$((H / 2 + Yoff - 60  / 2))
			if [ -n "${TEXT}" ]
			then
				MIDXt=$((W / 2 + Xoff - 285 / 2))
				MIDYt=$((H / 2 + Yoff + 320 / 2))
				LOCK+=(-font $FONT -pointsize 26 -fill lightgrey -stroke grey10 \
				   -strokewidth 2 -annotate +$MIDXt+$MIDYt "$TEXT" \
				   -fill lightgrey -stroke lightgrey -strokewidth 1 -annotate +$MIDXt+$MIDYt "$TEXT")
			fi
			LOCK+=($ICON -geometry +$MIDXi+$MIDYi -composite)
		fi
	done <<<"$(xrandr)"
	time2 convert "${LOCK_SCREEN_IMAGE}" "${LOCK[@]}" "${LOCK_SCREEN_IMAGE}"
}

function pre_lock() {
	if ! systemdservice
	then
		if [ "${MUTED}" = "no" ]
		then
			notify "Mute sound."
			i3-volume mute >/dev/null || notify "Could not mute the sound." >&2
		fi
		if [ "${PLAYERCTLSTATUS}" = "Playing" ]
		then
			notify "Stop any music player."
			playerctl stop || notify "Could not stop the music player." >&2
		fi
	fi

	notify "Disable presentation mode."
	presentation-mode stop

    # sleep because seems too soon after pres mode stop
	(
		sleep 1
		notify "Pause notifications."
		notify "$(killall -v -SIGUSR1 dunst 2>&1)"
	 ) &

	notify "Lock remote irssi screen."
	(irc lock ||:)&
}

function perform_lock() {
	# start the real lock command in the background, set the PID file,
	# then wait for the lock to end (when unlocked)
	if ifdebug2
	then
		notify "Now is when we would run i3lock, sleeping for ${LOCKSLEEP}s."
		time2 sleep ${LOCKSLEEP} &
	else
		notify "Running i3lock."
		time2 i3lock --show-failed-attempts --tiling --nofork --ignore-empty-password --image "${LOCK_SCREEN_IMAGE}" &
	fi

	# get and set i3lock pid
	local PID=$!
	setpid $PID

	# give i3lock a bit of time to display the image
	sleep 1

	## /etc/systemd/system/i3lock.service
	#
	# [Unit]
	# Description=i3lock
	# Before=sleep.target
	#
	# [Service]
	# User=serge
	# Type=notify
	# NotifyAccess=all
	# Environment=DISPLAY=:0.0
	# ExecStart=/home/serge/bin/lock
	# PIDFile=/var/run/user/1000/i3lock/pid
	# Environment=SYSTEMDSERVICE=yes
	#
	# [Install]
	# WantedBy=sleep.target
	#
	if systemdservice
	then
		systemd-notify --ready --status="Screen locked with image $LOCKSCREEN" &>/dev/null
		notify "Notifying systemd the lock is done."
	fi

	wait
}

function post_lock() {

	notify "Unlock remote irssi screen."
	(irc unlock ||:) &  # too many issues with ssh timeouts

    notify "Re-enable notifications."
	notify "$(killall -v -SIGUSR2 dunst 2>&1)"

	if ! systemdservice
	then
		# re-renable music if it was playing
		if [ "${PLAYERCTLSTATUS}" = "Playing" ]
		then
			notify "Restart music player."
			playerctl play || notify "Could not start the music player." >&2
		fi
		if [ "${MUTED}" = "no" ]
		then
			notify "Unmute the sounds again."
			i3-volume unmute >/dev/null || notify "Could not unmute the sound." >&2
		fi
	fi

	delpid
}

function setpid() {
	PID=${1:-$$}
	mkdir -p ${PIDPATH}
	echo $PID >"${PIDFILE}"
	notify "Lock process started with pid $PID, set in ${PIDFILE}."
}

function delpid() {
	notify "Removing PID file ${PIDFILE}."
	rm -f "${PIDFILE}"
}

function main() {
	# prepare lock screen image
	prepare

	# prepare system before locking
	pre_lock

    # lock screen with a lock screen image picture
	perform_lock

	# post lock to be run after screen is unlocked
	post_lock
	}

notify "Lock service started"
main

