#!/usr/bin/env bash
#set -x

# c-basic-offset: 4; tab-width: 4; indent-tabs-mode: t
# vi: set shiftwidth=4 tabstop=4 noexpandtab:
# :indentSize=4:tabSize=4:noTabs=false:

set -o nounset
set -o errexit
set -o pipefail

# shellcheck disable=SC1090
source "$HOME/bin/common.bash"

trap info INT TERM EXIT

###############################################################################

OIFS=$IFS
NIFS=$'\n'
IFS=$NIFS

dotadds="
.asdfrc
.bash_completion
.bash_logout
.bash_profile
.bashrc
.bashrc.d/
.config/alacritty/
.config/asdf-plugin-list
.config/dunst/dunstrc
.config/dunst/dunstrc.d_*
.config/gtk-2.0/
.config/gtk-3.0/
.config/helm/repositories.yaml
.config/helm/repo-list.yaml
.config/htop/
.config/krew-index-list
.config/krew-list
.config/nvim/           :!.config/nvim/plugged/           :!.config/nvim/plugged/
.config/pip/
.config/pulse/daemon.conf
.config/ranger/
.config/picom.conf
.config/sway/
.config/remmina
.config/user-dirs.dirs
.editorconfig
.gitconfig
.gitconfig.d/
.gitignore
.gitignore.d/dot
.git-template/
.i3/
.local/etc
.local/man/
.local/share/applications/
.local/share/bash-completion
.local/share/direnv/allow/
.local/share/doc/
.local/share/flatpak/ :!.local/share/flatpak/db/
.local/share/icons/
.local/share/nautilus/
.local/share/nemo/
.pam_environment
.pastebinit.xml
.profile
.screenlayout
.screenrc
.selected_editor
bin/
src/autops/cust/enperas/.envrc
src/autops/cust/equans/.envrc
src/autops/cust/viumore/.envrc
src/autops/cust/velleman/.envrc
src/autops/.envrc
src/ginsys/opsmaster/hwconfig/kube/.envrc
src/mateco/.envrc
"

sdotadds="
.config/gandi/
.config/mopidy/mopidy.conf
.docker/ :!.docker/buildx/
.aws/
.cert/
.config/gandi/
.config/gcloud/ :!.config/gcloud/*.db :!.config/gcloud/cache/ :!.config/gcloud/logs/ :!.config/gcloud/surface_data/ :!.config/gcloud/.last*
.config/gotify/
.config/hcloud/
.config/mopidy/
.config/scw/
.gitignore.d/sdot
.gnupg/
.kube/config-*.yaml
.kube/kubie.yaml
.local/share/remmina/
.s3cfg
.src/
.ssh/ :!.ssh/*_known_hosts :!.ssh/known_hosts*
.talos/
bins/
etc/
"


###############################################################################

function dotsadd() {
	cd $HOME

	for entry in ${dotadds}
	do
		IFS=$OIFS
	    vcsh run dot git add --force ${entry}
		IFS=$NIFS
	done
	for entry in ${sdotadds}
	do
		IFS=$OIFS
	    vcsh run sdot git add --force ${entry}
		IFS=$NIFS
	done
}

function title() {
	local msg
	IFS=$OIFS
	msg="${*}"

	echo -e "\n--------------------------------"
	echo -e "${msg} ... \n"
	IFS=$NIFS
}

function info() {
	title Status
	vcsh foreach status --short --branch --verbose --show-stash
}

###############################################################################

cd $HOME
action="${1:-}"

if [ -z "${action}" ]
then
	title Usage $0
	echo "up | pull | add | commit | push | all"
	exit
fi
if [ "${action}" = "up" ] || [ "${action}" = "all" ]
then
	title Update
	vcsh foreach remote update --prune
fi
if [ "${action}" = "pull" ] || [ "${action}" = "all" ]
then
	title Pull
	vcsh foreach pull --autostash
fi
if [ "${action}" = "add" ] || [ "${action}" = "all" ]
then
	title Add
	dotsadd
fi
if [ "${action}" = "commit" ] || [ "${action}" = "all" ]
then
	title Committing
	vcsh foreach commit -m "update from $HOSTNAME"
fi
if [ "${action}" = "push" ] || [ "${action}" = "all" ]
then
	title Pushing
	vcsh foreach pushall
fi
