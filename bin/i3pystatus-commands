#!/usr/bin/env bash

# c-basic-offset: 4; tab-width: 4; indent-tabs-mode: t
# vi: set shiftwidth=4 tabstop=4 expandtab:
# :indentSize=4:tabSize=4:noTabs=false:

set -o nounset
set -o errexit
set -o pipefail

# shellcheck disable=SC1090
source "$HOME/bin/common.bash"

###############################################################################

function execute() {
    args=$1
    output=$(eval $args 2>/dev/null || :)
}

case ${1:-} in
    audio_current_sink)
        execute "pa-default long | sed -e 's/ - / /' -e 's/Built-in.*/Builtin/' -e 's/HyperX 7.1 Audio Analog Stereo/Trust/' 2>/dev/null ||:"
        ;;
    audio_current_sink_volume)
        if ponymix is-muted; then
            output="ðŸš«"
        else
            execute "ponymix get-volume"
            if [ -n "${output}" ]; then
                if [ "${output}" -gt 0 ]; then
                    output="ðŸ”Š${output}%"
                else
                    [ "${output}" -eq 0 ]
                    output="ðŸš«"
                fi
            fi
        fi
        ;;
    audio_sonos_volume)
        execute "sonos state 2>/dev/null ||:"
        if [ "${output}" = "PLAYING" ]; then
            execute "sonos volume 2>/dev/null ||:"
            if [ "${output}" -gt 0 ]; then
                output="Sonos ðŸ”Š${output}%"
            else
                [ "${output}" -eq 0 ]
                output="Sonos ðŸš«"
            fi
        else
            output=""
        fi

        ;;
    wifi)
        execute "nmcli -t radio wifi"
        if [ "${output}" = "enabled" ]; then
            output="ï‡«"
        else
            output="âŠ¥"
        fi
        ;;
    now_playing)
        output=""
        statusfile="$HOME/.playerctl_active"
        player="$(head -n 1 "$statusfile" 2>/dev/null || :)"

        # Find a currently playing player (replicates wrapper logic)
        playing=""
        players="$(/usr/bin/playerctl --list-all 2>/dev/null || :)"
        if [ -n "$players" ] && [ "$players" != "No players found" ]; then
            for p in $players; do
                if [ "$(/usr/bin/playerctl --player "$p" status 2>/dev/null || :)" = "Playing" ]; then
                    playing="$p"
                    break
                fi
            done
        fi

        # Auto-switch: active player dead or different player is playing
        if [ -z "$player" ] || ! /usr/bin/playerctl --player "$player" status &>/dev/null; then
            player="$playing"
            echo "$player" > "$statusfile"
        elif [ -n "$playing" ] && [ "$player" != "$playing" ]; then
            player="$playing"
            echo "$player" > "$statusfile"
        fi

        if [ -n "$player" ]; then
            state="$(/usr/bin/playerctl --player "$player" status 2>/dev/null || :)"

            if [ "$state" = "Playing" ]; then
                stat="â–¶  "
                if [ "$player" = "vlc" ]; then
                    title="$(/usr/bin/playerctl --player "$player" metadata vlc:nowplaying 2>/dev/null || :)"
                    artist="$(/usr/bin/playerctl --player "$player" metadata xesam:title 2>/dev/null || :)"
                else
                    artist="$(/usr/bin/playerctl --player "$player" metadata xesam:artist 2>/dev/null || :)"
                    title="$(/usr/bin/playerctl --player "$player" metadata xesam:title 2>/dev/null || :)"
                fi
                if [ -n "$artist" ]; then
                    if [ -n "$title" ]; then
                        artist="${artist}: "
                        title="$title "
                    else
                        artist="${artist} "
                    fi
                else
                    if [ -n "$title" ]; then
                        title="$title "
                    fi
                fi
                output="${player} ${stat}${artist}${title}"
            elif [ "$state" = "Paused" ]; then
                output="${player} â–Œâ–Œ "
            elif [ "$state" = "Stopped" ]; then
                output="${player} â—¼ "
            else
                output="${player} â—¼ "
            fi
        else
            output="â—¼ "
        fi
        ;;
    *)
        notify_error "$(
            echo "Possible options are:"
            grep -e '^[[:space:]].*)' $0 | grep -v '(' | sed -e 's/\s//g' -e 's/\*//' -e 's/)//'
        )\n"
        output="UNKNOWN ITEM"
        ;;
esac

[ -z "${output}" ] && output="."
echo -n "${output}"
