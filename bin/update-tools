#!/bin/bash

# c-basic-offset: 4; tab-width: 4; indent-tabs-mode: t
# vi: set shiftwidth=4 tabstop=4 noexpandtab:
# :indentSize=4:tabSize=4:noTabs=false:

set -o nounset
#set -o errexit
#set -o pipefail

# shellcheck disable=SC1090
source "$HOME/bin/common.bash"

######################################################################################################################
######################################################################################################################

title() {
	echo
	echo "################################################################################################################"
	echo "# ${1}"
	echo "################################################################################################################"
	echo
}

######################################################################################################################
######################################################################################################################

mkdir ~/tmp/update-tools/ -p
cd ~/tmp/update-tools/

######################################################################################################################

title "kubetail" 
curl --connect-timeout 5 https://raw.githubusercontent.com/johanhaleby/kubetail/master/kubetail > $HOME/bin/kubetail ; chmod +x $HOME/bin/kubetail
curl --connect-timeout 5 https://raw.githubusercontent.com/johanhaleby/kubetail/master/completion/kubetail.bash > $HOME/.bashrc.d/completions.kubetail.bash

######################################################################################################################

title "kubescape"
VERSION=$(curl --connect-timeout 5 -s https://api.github.com/repos/armosec/kubescape/releases/latest | jq -r .tag_name)
curl --connect-timeout 5 -L https://github.com/armosec/kubescape/releases/download/${VERSION}/kubescape-ubuntu-latest -o $HOME/bin2/kubescape && chmod +x $HOME/bin2/kubescape

######################################################################################################################

title "mizu"
curl --connect-timeout 5 -Lo mizu github.com/up9inc/mizu/releases/latest/download/mizu_linux_amd64 && chmod 755 mizu && mv -v mizu $HOME/bin2

######################################################################################################################

title "cleanup ########################################################################################################"
cd $HOME
rm -rfv ~/tmp/update-tools/

######################################################################################################################

title "asdf ########################################################################################################"
asdf update
for plugin in $(asdf plugin-list|xargs)
do 	
title "asdf - ${plugin} ##########################################################################"
	asdf plugin-update ${plugin} 
	asdf install ${plugin} latest
	asdf global ${plugin} latest
done

######################################################################################################################

title "krew"
cd $HOME
ln -nfs $(asdf which kubectl-krew  | sed s@/bin/kubectl-krew@@) ~/.krew
krew update && krew upgrade

######################################################################################################################

title "generate bash completions"
$HOME/bin/generate_bash_completions_from_binaries.sh

######################################################################################################################

title "end"

######################################################################################################################

