#!/bin/bash

# c-basic-offset: 4; tab-width: 4; indent-tabs-mode: t
# vi: set shiftwidth=4 tabstop=4 noexpandtab:
# :indentSize=4:tabSize=4:noTabs=false:

set -o nounset
#set -o errexit
#set -o pipefail

# shellcheck disable=SC1090
source "$HOME/bin/common.bash"

###############################################################################

title() {
	set +x
	echo
	echo "###############################################################################"
	echo ${1}
	echo "###############################################################################"
	echo
	set -x
}

#######################################################################################################################

cd ~/tmp/

title starship ########################################################################################################
/home/serge/bin2/starship -V
starship-upgrade
/home/serge/bin2/starship -V

title kubie ###########################################################################################################
/home/serge/bin2/kubie update

title kubetail ########################################################################################################
curl https://raw.githubusercontent.com/johanhaleby/kubetail/master/kubetail > $HOME/bin/kubetail ; chmod +x $HOME/bin/kubetail
curl https://raw.githubusercontent.com/johanhaleby/kubetail/master/completion/kubetail.bash > $HOME/.bashrc.d/completions.kubetail.bash

title lazykube ########################################################################################################
curl https://raw.githubusercontent.com/TNK-Studio/lazykube/main/scripts/install_update_linux.sh | sed s/sudo//g | DIR=$HOME/bin2/  bash -x

title flux ############################################################################################################
/home/serge/bin2/flux -v
curl -s https://fluxcd.io/install.sh | bash -s ~/bin2/
/home/serge/bin2/flux -v

title vcluster ########################################################################################################
/home/serge/bin2/vcluster upgrade

title kdash ###########################################################################################################
curl https://raw.githubusercontent.com/kdash-rs/kdash/main/deployment/getLatest.sh | sed s@/usr/local/bin@/home/serge/bin2@ | bash -x

title havener #########################################################################################################
curl -sL https://raw.githubusercontent.com/homeport/havener/main/scripts/download-latest.sh | sed 's@${HOME}/bin@${HOME}/bin2@' | bash -x

#kubescape
curl -s https://raw.githubusercontent.com/armosec/kubescape/master/install.sh | sed -e s/sudo// -e s@/usr/local/bin@$HOME/bin2@ | bash -x

#kubecm https://kubecm.cloud/#/
VERSION=$(curl -s https://api.github.com/repos/sunny0826/kubecm/releases/latest | jq -r .tag_name)
NAME=$(curl -s https://api.github.com/repos/sunny0826/kubecm/releases/latest | jq -r .name)
curl -L https://github.com/sunny0826/kubecm/releases/download/${VERSION}/${NAME}_Linux_x86_64.tar.gz | tar -zxvf - kubecm && mv kubecm $HOME/bin2

title kubescape #######################################################################################################
VERSION=$(curl -s https://api.github.com/repos/armosec/kubescape/releases/latest | jq -r .tag_name)
curl -L https://github.com/armosec/kubescape/releases/download/${VERSION}/kubescape-ubuntu-latest -o $HOME/bin2/kubescape && chmod +x $HOME/bin2/kubescape

title k9s #############################################################################################################
VERSION=$(curl -s https://api.github.com/repos/derailed/k9s/releases/latest | jq -r .tag_name)
curl -L https://github.com/derailed/k9s/releases/download/${VERSION}/k9s_Linux_x86_64.tar.gz -o $HOME/tmp/k9s_Linux_x86_64.tar.gz && \
	tar -xvf $HOME/tmp/k9s_Linux_x86_64.tar.gz && mv $HOME/tmp/k9s $HOME/bin2/k9s



## https://github.com/danielfoehrKn/kubeswitch
#OS=linux                        # Pick the right os: linux, darwin (intel only)
#VERSION=$(curl -s https://api.github.com/repos/danielfoehrKn/kubeswitch/releases/latest | jq -r .tag_name) # Pick the current version.
#curl -L -o $HOME/bin2/switcher https://github.com/danielfoehrKn/kubeswitch/releases/download/${VERSION}/switcher_${OS}_amd64
#curl -L -o $HOME/bin2/switch https://github.com/danielfoehrKn/kubeswitch/releases/download/${VERSION}/switch.sh
#curl -L -o $HOME/.bashrc.d/completions-kubeswitch.bash https://raw.githubusercontent.com/danielfoehrKn/kubeswitch/master/script/_switch.bash
#chmod -v +x $HOME/bin2/switch{,er}

title kubectl #########################################################################################################
curl -L -o $HOME/bin2/kubectl "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl" && chmod +x $HOME/bin2/kubectl

title clusterctl ######################################################################################################
VERSION=$(curl --silent "https://api.github.com/repos/kubernetes-sigs/cluster-api/releases/latest" | jq -r .tag_name)
curl -Lo $HOME/bin2/clusterctl "https://github.com/kubernetes-sigs/cluster-api/releases/download/${VERSION}/clusterctl-linux-amd64"
chmod +x $HOME/bin2/clusterctl

mv $HOME/bin2/kustomize $HOME/bin2/kustomize.old ; \
  curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash -s $HOME/Documents/Applications/bin/
																													# not bin2 as script does funky stuff with the symlink

title certmanager cli #################################################################################################
OS=$(go env GOOS); ARCH=$(go env GOARCH); curl -L -o cmctl.tar.gz https://github.com/jetstack/cert-manager/releases/latest/download/cmctl-$OS-$ARCH.tar.gz
tar xzf cmctl.tar.gz
mv cmctl /$HOME/bin2
rm cmctl.tar.gz

title datree ##########################################################################################################
curl https://get.datree.io | sed s@/usr/local/bin@$HOME/bin2@ | /bin/bash

title scaleway cli ####################################################################################################
curl -o $HOME/bin2/scw -L $(curl -s https://api.github.com/repos/scaleway/scaleway-cli/releases/latest  | jq -r '.assets[]|select(.name|endswith("linux-x86_64")).browser_download_url')

title krew plugins ####################################################################################################
(
  set -x; cd "$(mktemp -d)" &&
  OS="$(uname | tr '[:upper:]' '[:lower:]')" &&
  ARCH="$(uname -m | sed -e 's/x86_64/amd64/' -e 's/\(arm\)\(64\)\?.*/\1\2/' -e 's/aarch64$/arm64/')" &&
  KREW="krew-${OS}_${ARCH}" &&
  curl -fsSLO "https://github.com/kubernetes-sigs/krew/releases/latest/download/${KREW}.tar.gz" &&
  tar zxvf "${KREW}.tar.gz" &&
  ./"${KREW}" install krew
)
krew upgrade

title arkade ##########################################################################################################
mkdir $HOME/.arkade/bin -p
curl -SLfs https://dl.get-arkade.dev | sed -e 's@BINLOCATION="/usr/local/bin"@BINLOCATION="$HOME/.arkade/bin"@' -e 's@rm "$targetFile"@echo not rm "$targetFile"@' | sh
ls $HOME/.arkade/bin | xargs -n1 arkade get
ls -l $HOME/.arkade/bin

title microconfig https://github.com/microconfig/microconfig ##########################################################
URL=$(curl -s https://api.github.com/repos/microconfig/microconfig/releases/latest | jq -r .assets[].browser_download_url | grep linux)
curl -SLfs -o latest.zip ${URL}
unzip latest
chmod -v +x microconfig
mv -v microconfig $HOME/bin2

title argocd ##########################################################################################################
URL=$(curl -s https://api.github.com/repos/argoproj/argo-cd/releases/latest  | jq -r .assets[].browser_download_url | grep linux)
curl -SLfs -o $HOME/bin2/argocd ${URL}
chmod +x $HOME/bin2/argocd

#argocd-autpilot
VERSION=$(curl --silent "https://api.github.com/repos/argoproj-labs/argocd-autopilot/releases/latest" | jq -r .tag_name)
curl -L --output - https://github.com/argoproj-labs/argocd-autopilot/releases/download/$VERSION/argocd-autopilot-linux-amd64.tar.gz | tar zx
mv ./argocd-autopilot-* $HOME/bin2/argocd-autopilot

title argocd - check the installation #################################################################################
/home/serge/bin2/argocd-autopilot version

title silver-surfer, kubedd ###########################################################################################
VERSION=$(curl --silent "https://api.github.com/repos/devtron-labs/silver-surfer/releases/latest" | jq -r .tag_name)
curl -L --output - https://github.com/devtron-labs/silver-surfer/releases/download/${VERSION}/silver-surfer_${VERSION/v}_linux_amd64.tar.gz | tar zx
mv ./kubedd $HOME/bin2/kubedd

title kubeval #########################################################################################################
wget https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
tar xf kubeval-linux-amd64.tar.gz
mv kubeval $HOME/bin2/

title trivy ###########################################################################################################
curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b $HOME/bin2

title jless ###########################################################################################################
VERSION=$(curl --silent "https://api.github.com/repos/PaulJuliusMartinez/jless/releases"  | jq .[].tag_name | sort -n | tail -n1 | sed 's/"//g')
curl -OL https://github.com/PaulJuliusMartinez/jless/releases/download/${VERSION}/jless-${VERSION}-x86_64-unknown-linux-gnu.zip
unzip jless-${VERSION}-x86_64-unknown-linux-gnu.zip
mv ./jless $HOME/bin2/

title mizu ############################################################################################################
curl -Lo mizu github.com/up9inc/mizu/releases/latest/download/mizu_linux_amd64 && chmod 755 mizu && mv mizu $HOME/bin2

title talosctl ########################################################################################################
VERSION=$(curl --silent "https://api.github.com/repos/siderolabs/talos/releases/latest" | jq -r .tag_name)
curl -Lo $HOME/bin2/talosctl https://github.com/siderolabs/talos/releases/download/${VERSION}/talosctl-linux-amd64

title crossplane.io ###################################################################################################
curl -sLo $HOME/bin2/kubectl-crossplane https://releases.crossplane.io/stable/current/bin/linux_amd64/crank
chmod +x $HOME/bin2/kubectl-crossplane

title update completions ##############################################################################################
$HOME/bin/generate_bash_completions_from_binaries.sh
