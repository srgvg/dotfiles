#!/bin/bash

# c-basic-offset: 4; tab-width: 4; indent-tabs-mode: t
# vi: set shiftwidth=4 tabstop=4 noexpandtab:
# :indentSize=4:tabSize=4:noTabs=false:

set -o nounset
#set -o errexit
#set -o pipefail

# shellcheck disable=SC1090
source "$HOME/bin/common.bash"

##########################################################################################################
##########################################################################################################

title() {
	echo
	echo "################################################################################################################"
	echo "# ${1}"
	echo "################################################################################################################"
	echo
}

##########################################################################################################
##########################################################################################################

mkdir ~/tmp/update-tools/ -p
cd ~/tmp/update-tools/

##########################################################################################################

title "kubetail"
curl --connect-timeout 5 https://raw.githubusercontent.com/johanhaleby/kubetail/master/kubetail > $HOME/bin/kubetail ; chmod +x $HOME/bin/kubetail
curl --connect-timeout 5 https://raw.githubusercontent.com/johanhaleby/kubetail/master/completion/kubetail.bash > $HOME/.bashrc.d/completions.kubetail.bash

##########################################################################################################

title "kubescape"
VERSION=$(curl --connect-timeout 5 -s https://api.github.com/repos/kubescape/kubescape/releases/latest | jq -r .tag_name)
curl --connect-timeout 5 -L https://github.com/kubescape/kubescape/releases/download/${VERSION}/kubescape-ubuntu-latest -o $HOME/bin2/kubescape && chmod +x $HOME/bin2/kubescape

##########################################################################################################

title "kubeshark"
VERSION=$(curl --connect-timeout 5 -s https://api.github.com/repos/kubeshark/kubeshark/releases/latest | jq -r .tag_name)
curl --connect-timeout 5 -L https://github.com/kubeshark/kubeshark/releases/download/${VERSION}/kubeshark_linux_amd64 -o $HOME/bin2/kubeshark && chmod +x $HOME/bin2/kubeshark

##########################################################################################################

title "cilium"

CLI_ARCH=amd64
CILIUM_CLI_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/cilium-cli/master/stable.txt)
HUBBLE_CLI_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/hubble/master/stable.txt)
curl -L --fail --remote-name-all https://github.com/cilium/cilium-cli/releases/download/${CILIUM_CLI_VERSION}/cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}
curl -L --fail --remote-name-all https://github.com/cilium/hubble/releases/download/${HUBBLE_CLI_VERSION}/hubble-linux-${CLI_ARCH}.tar.gz{,.sha256sum}
sha256sum --check cilium-linux-${CLI_ARCH}.tar.gz.sha256sum
sha256sum --check hubble-linux-${CLI_ARCH}.tar.gz.sha256sum
tar xzvfC cilium-linux-${CLI_ARCH}.tar.gz $HOME/bin2/
tar xzvfC hubble-linux-${CLI_ARCH}.tar.gz $HOME/bin2/
rm {cilium,hubble}-linux-${CLI_ARCH}.tar.gz{,.sha256sum}

##########################################################################################################

title "civo"
# located in bin2
civo update

##########################################################################################################

title "go-chromecast  ########################################################################################################"

TARGETOS="linux"
TARGETARCH="amd"
TARGETVARIANT="64"
GC_URL=$(wget https://api.github.com/repos/vishen/go-chromecast/releases/latest -O - \
			| jq -r '.assets[].browser_download_url' \
			| grep ${TARGETOS}_${TARGETARCH}${TARGETVARIANT} \
		)
wget $GC_URL -O ./go-chromecast.tgz
tar xzf ./go-chromecast.tgz -C $HOME/bin2/
chmod +x $HOME/bin2/go-chromecast


##########################################################################################################

title "kubedialog  ########################################################################################################"

wget https://raw.githubusercontent.com/vaniacer/kube-dialog/master/kd
chmod +  kd
cp kd $HOME/bin/kube-dialog

##########################################################################################################

title "jqp"
VERSION=$(curl --connect-timeout 5 -s https://api.github.com/repos/noahgorstein/jqp/releases/latest | jq -r .tag_name)
_VERSION=${VERSION/v}
curl --connect-timeout 5 -L https://github.com/noahgorstein/jqp/releases/download/${VERSION}/jqp_${_VERSION}_Linux_x86_64.tar.gz -o ~/tmp/update-tools/jqp.tgz
tar -xvzf ~/tmp/update-tools/jqp.tgz
mv ~/tmp/update-tools/jqp $HOME/bin2/jqp && chmod +x $HOME/bin2/jqp

##########################################################################################################

title "asdf ########################################################################################################"
$HOME/bin/update-asdf

##########################################################################################################

title "update flatpak"

flatpak update --assumeyes --noninteractive
flatpak update --assumeyes --noninteractive --user
flatpak remote-ls > /tmp/flatpak.remotes && mv /tmp/flatpak.remotes $HOME/.local/share/flatpak/remotes.ls
flatpak list      > /tmp/flatpak.list    && mv /tmp/flatpak.list    $HOME/.local/share/flatpak/list.ls

##########################################################################################################

title "helm repo update"

helm repo update
helm repo list > /tmp/helm-repositories.yaml && mv /tmp/helm-repositories $HOME/.config/helm/repositories.yaml


##########################################################################################################

title "krew"
ln -nfs $(asdf which kubectl-krew  | sed s@/bin/kubectl-krew@@) $HOME/.krew
update-krew

##########################################################################################################

title "kubedash"
curl https://raw.githubusercontent.com/kdash-rs/kdash/main/deployment/getLatest.sh | sed "s@EXE_DEST_DIR=\"/usr/local/bin\"@EXE_DEST_DIR=\"$HOME/bin2\"@" | bash

##########################################################################################################

title "generate bash completions"
$HOME/bin/update-bash-completions.sh

##########################################################################################################

title "add gitignores"
$HOME/bin/dotfiles add

##########################################################################################################

title "cleanup ########################################################################################################"
cd $HOME
rm -rfv ~/tmp/update-tools/

##########################################################################################################

title "end"

##########################################################################################################

