#!/bin/bash

# c-basic-offset: 4; tab-width: 4; indent-tabs-mode: t
# vi: set shiftwidth=4 tabstop=4 noexpandtab:
# :indentSize=4:tabSize=4:noTabs=false:

# sway-get-window-criteria - Get criteria for use with Sway for_window commands
#
# Usage: Run this script, then click on a window (3s delay if interactive).
# Output format: [app_id="..." title="..." shell="..."] ready for Sway config
#
# Copies formatted criteria to clipboard via wl-copy.

set -o nounset
set -o errexit
set -o pipefail


# shellcheck disable=SC1090
source "$HOME/bin/common.bash"

ifinteractive && sleep 3

# Single swaymsg call
tree_json="$(swaymsg -t get_tree -r)" || {
	notify_desktop_always critical "Sway Window Properties" "Failed to get window tree"
	exit 1
}

# Extract all properties in one jq pass (newline-separated)
props="$(echo "$tree_json" | jq -r '
	recurse | select(.focused? == true) |
	[
		(if .app_id then "app_id=\"\(.app_id)\"" else empty end),
		(if .name then "title=\"\(.name)\"" else empty end),
		(if .shell then "shell=\"\(.shell)\"" else empty end),
		(.window_properties // {} | to_entries[] |
			select(.key == "class" or .key == "instance" or .key == "window_role" or .key == "window_type") |
			"\(.key)=\"\(.value)\""
		)
	] | .[]
')"

# Handle no focused window
if [[ -z "$props" ]]; then
	notify_desktop_always normal "Sway Window Properties" "No focused window found"
	exit 0
fi

# Format for Sway config (space-separated in brackets)
props_inline="$(echo "$props" | paste -sd ' ')"
formatted="[$props_inline]"

# Output
echo "$props"
echo
echo "$formatted"
echo
notify_desktop_always low "Sway Window Properties" "$formatted"
echo -n "$formatted" | wl-copy
