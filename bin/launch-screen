#!/bin/bash

session_exists() {
    if (screen -list | grep "\.$sname" > /dev/null)
    then    return 0
    else    return 1
    fi
    }

not_empty() {
    if [ ! -z "$*" ]
    then    return 0
    else    return 1
    fi
    }

check_options() {
    if [ -x "`which "$3" 2>/dev/null`" ]
    then  # command starts at third parameter,
          # first is session name, second a special commandoption
        sname="$1"
        shift # name is gone
        cmd="$1"
        shift # cmd is gone
        command="$*"

    elif [ -x "`which "$2" 2>/dev/null`" ]
    then  # command starts at second parameter, first is session name
        cmd="_start_or_attach"
        sname="$1"
        shift # name is gone
        command="$*"

    elif [ -x "`which "$1" 2>/dev/null`" ]
    then  # command starts at first parameter
        cmd="_start_or_attach"
        sname="$1"
        command="$*"

    else # no command, just reattach
        sname="$1"
        cmd="_start_or_attach"
    fi
    wname=`echo $command | sed 's/\s/_/g'`
    }

build_screen_options() {
    case $cmd in
        _start_or_attach)
            if session_exists
            then # attach
                echo "attach to screen session $sname"
                options="-Rx $sname"
                command=""
            else # start new
                if not_empty $command
                then
                    echo "start new screen session $sname"
                    options="-S $sname -t $wname -d -m"
                else # will fail
                    options=""
                fi
            fi
            ;;
        add)
            if not_empty $command
            then
                if session_exists
                then # add new window and command
                    echo "add new command to session $sname"
                    options="-S $sname -X screen"
                else # start new
                    echo "start new screen session $sname"
                    options="-S $sname -t $wname -d -m"
                fi
            else
                options=""
            fi
            ;;
        *)
            options=""
            command=""
            ;;
    esac
    }

execute_screen() {
    echo Executing: screen $options $command
    screen $options $command
    }

main() {
    if not_empty $*
    then
        check_options $*
        build_screen_options $*
        if [ ! -z "$options$command" ]
        then
            execute_screen
        else
            echo "no command given"
        fi
    else
        echo "missing session name" >&2
    fi
    screen -list
    }

main $*
