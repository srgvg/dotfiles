#!/bin/bash

# c-basic-offset: 4; tab-width: 4; indent-tabs-mode: t
# vi: set shiftwidth=4 tabstop=4 noexpandtab:
# :indentSize=4:tabSize=4:noTabs=false:

set -o nounset
set -o errexit
set -o pipefail


# shellcheck disable=SC1090
source "$HOME/bin/common.bash"

session_exists() {
    if (screen -list | grep "\.$sname" > /dev/null)
    then    return 0
    else    return 1
    fi
    }

not_empty() {
    if [ ! -z "$*" ]
    then    return 0
    else    return 1
    fi
    }

check_options() {
	if [ -x "$(which "$3" 2>/dev/null)" ]
    then  # command starts at third parameter,
          # first is session name, second a special commandoption
        sname="$1"
        shift # name is gone
        cmd="$1"
        shift # cmd is gone
        command="$*"

	elif [ -x "$(which "$2" 2>/dev/null)" ]
    then  # command starts at second parameter, first is session name
        cmd="_start_or_attach"
        sname="$1"
        shift # name is gone
        command="$*"

	elif [ -x "$(which "$1" 2>/dev/null)" ]
    then  # command starts at first parameter
        cmd="_start_or_attach"
        sname="$1"
        command="$*"

    else # no command, just reattach
        if [ $# -eq 0 ] || [ $# -ge 3 ]
        then
            exit 1
        elif [ $# -eq 1 ]
        then
            sname="$1"
            cmd="_start_or_attach"
        elif [ $# -eq 2 ]
        then
            sname="$1"
            cmd="$2"
        fi
    fi
	wname="$(echo $command | sed -e 's/-//g' -e 's/\s/_/g')"
    }

build_screen_options() {
    case $cmd in
        _start_or_attach)
            if session_exists
            then # attach
                echo "attach to screen session $sname"
                options="-Rx $sname"
                command=""
            else # start new
                if not_empty $command
                then
                    echo "start new screen session $sname"
                    options="-S $sname -t $wname -d -m"
                else # will fail
                    options=""
                fi
            fi
            ;;
        add)
            if not_empty $command
            then
                if session_exists
                then # add new window and command
                    echo "add new command to session $sname"
                    options="-S $sname -X screen -t $wname"
                else # start new
                    echo "start new screen session $sname"
                    options="-S $sname -t $wname -d -m"
                fi
            else
                options=""
            fi
            ;;
        lockscreen)
            options="-S $sname -X lockscreen"
            command=""
            ;;
        *)
            options=""
            command=""
            ;;
    esac
    }

execute_screen() {
    if [ "$options" = "-S $sname -X screen -t $wname" ]
    then    echo "Wait a bit to add a screen"
            sleep 1s   # $[ ( $RANDOM % 3 )  + 1 ]s
    fi
    echo Executing: screen $options $command
    screen $options $command
    }

main() {
    if not_empty "$@"
    then
        check_options "$@"
        build_screen_options "$@"
        if [ ! -z "$options$command" ]
        then
            execute_screen
        else
            echo "no command given"
        fi
    else
        echo "missing session name" >&2
    fi
    screen -list
    }

main "$@"
